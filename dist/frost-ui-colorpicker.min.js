!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@fr0st/query"),require("@fr0st/ui"),require("@fr0st/color")):"function"==typeof define&&define.amd?define(["exports","@fr0st/query","@fr0st/ui","@fr0st/color"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.fQuery,t.UI,t.Color)}(this,(function(t,e,i,s){"use strict";function o(t){return Number(t).toLocaleString("en-US",{style:"percent"})}function a(t){if(!t)return null;if(t instanceof s)return t;try{return s.fromString(t)}catch(t){return null}}class n extends i.BaseComponent{constructor(t,i){super(t,i);const o=e.getValue(this._node);"auto"===this._options.format&&(this._options.format=function(t){if(!t)return null;if("#"===t.substring(0,1))return"hex";const e=t.substring(0,3);return["rgb","hsl"].includes(e)?e:null}(o)),this._options.defaultColor&&(this._defaultColor=a(this._options.defaultColor)),this._defaultColor||(this._defaultColor=new s),this._color=a(o),this._options.inline?this._options.modal=!1:!this._options.modal&&this._options.mobileModal&&(this._options.modal=/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)),this._options.modal&&(this._options.horizontal=!0);const n=e.closest(this._node,".input-group").shift();if(n&&(this._inputGroupColor=e.findOne(".input-group-color",n)),this._color||o&&!this._options.keepInvalid){const t=this._getString(this._color);e.setValue(this._node,t)}this._render(),this._events(),this._options.modal&&(this._renderModal(),this._eventsModal()),this._values={alpha:1,brightness:0,hue:0,saturation:0},this._updateAttributes(),this._refresh(),this._refreshDisabled(),e.setData(this._menuNode,{input:this._node})}disable(){e.setAttribute(this._node,{disabled:!0}),this._refreshDisabled()}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),this._modal&&(i.Modal.init(this._modal).dispose(),e.removeEvent(this._modal,"show.ui.modal"),e.removeEvent(this._modal,"shown.ui.modal"),e.removeEvent(this._modal,"hide.ui.modal"),e.removeEvent(this._modal,"hidden.ui.modal"),e.removeEvent(this._setBtn,"click.ui.modal"),this._modal=null,this._setBtn=null),e.removeEvent(this._node,"change.ui.colorpicker"),e.removeEvent(this._node,"input.ui.colorpicker"),e.removeEvent(this._node,"click.ui.colorpicker"),e.removeEvent(this._node,"focus.ui.colorpicker"),e.removeEvent(this._node,"keydown.ui.colorpicker"),e.removeEvent(this._node,"keyup.ui.colorpicker"),this._inputGroupColor&&e.removeEvent(this._inputGroupColor,"click.ui.colorpicker"),e.remove(this._menuNode),this._color=null,this._defaultColor=null,this._inputGroupColor=null,this._menuNode=null,this._container=null,this._saturation=null,this._saturationGuide=null,this._hue=null,this._hueGuide=null,this._alpha=null,this._alphaColor=null,this._alphaGuide=null,this._preview=null,this._previewColor=null,this._values=null,super.dispose()}enable(){e.removeAttribute(this._node,"disabled"),this._refreshDisabled()}getColor(){return this._color}hide(){if(this._options.inline)return;if(this._options.modal)return void i.Modal.init(this._modal).hide();if(!e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||!e.triggerOne(this._node,"hide.ui.colorpicker"))return;e.setDataset(this._menuNode,{uiAnimating:"out"});const t=e.find('[tabindex="0"]',this._menuNode);e.setAttribute(t,{tabindex:-1}),e.fadeOut(this._menuNode,{duration:this._options.duration}).then((t=>{this._popper.dispose(),this._popper=null,e.detach(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),e.triggerEvent(this._node,"hidden.ui.colorpicker")})).catch((t=>{"out"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))}setColor(t){null!==t?(t=a(t))&&(this._options.alpha||(t=t.setAlpha(1)),this._setColor(t)):this._setColor(t)}show(){if(this._options.inline||e.isConnected(this._menuNode)||!this._isEditable())return;if(this._options.modal){if(this._options.appendTo)e.append(this._options.appendTo,this._modal);else{const t=e.closest(this._node,".modal").shift();t?e.after(t,this._modal):e.after(this._node,this._modal)}const t=i.Modal.init(this._modal);return this._activeTarget&&(t._activeTarget=this._activeTarget),void t.show()}if(e.getDataset(this._menuNode,"uiAnimating")||!e.triggerOne(this._node,"show.ui.colorpicker"))return;e.setDataset(this._menuNode,{uiAnimating:"in"});const t=e.find('[tabindex="-1"]',this._menuNode);e.setAttribute(t,{tabindex:0}),this._options.appendTo?e.append(this._options.appendTo,this._menuNode):e.after(this._node,this._menuNode),this._popper=new i.Popper(this._menuNode,{reference:this._node,placement:this._options.placement,position:this._options.position,fixed:this._options.fixed,spacing:this._options.spacing,minContact:this._options.minContact}),e.fadeIn(this._menuNode,{duration:this._options.duration}).then((t=>{e.removeDataset(this._menuNode,"uiAnimating"),e.triggerEvent(this._node,"shown.ui.colorpicker")})).catch((t=>{"in"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))}toggle(){e.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper&&this._popper.update()}}n.defaults={format:"auto",defaultColor:null,alpha:!0,inline:!1,horizontal:!1,keepInvalid:!1,ignoreReadonly:!1,modal:!1,mobileModal:!0,duration:100,appendTo:null,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},n.classes={alpha:"colorpicker-alpha flex-grow-1",alphaColor:"colorpicker-alpha-color",container:"d-flex justify-content-between",containerHorizontal:"flex-column",disabled:"colorpicker-disabled",guide:"colorpicker-guide",hue:"colorpicker-hue flex-grow-1",menu:"colorpicker",menuHorizontal:"colorpicker-horizontal",menuInline:"colorpicker-inline",menuModal:"colorpicker-modal",menuPadding:"p-2",modal:"modal",modalBody:"modal-body",modalBtnContainer:"text-end mt-4",modalBtnPrimary:"btn btn-primary ripple ms-2",modalBtnSecondary:"btn btn-secondary ripple ms-2",modalContent:"modal-content",modalDialog:"modal-dialog modal-sm",preview:"colorpicker-bar colorpicker-preview",saturation:"colorpicker-saturation",spacingHorizontal:"mt-2",spacingModal:"mt-3",spacingVertical:"me-2"},n.lang={alpha:"Alpha",brightness:"Brightness",color:"Color",hue:"Hue",saturation:"Saturation"},n.parseColor=a;const r=n.prototype;r._events=function(){const t=e.mouseDragFactory((t=>{if(t.button)return!1;e.focus(this._saturationGuide)}),(t=>{const e=i.getPosition(t);this._updateSaturation(e.x,e.y)}));e.addEvent(this._saturation,"mousedown.ui.colorpicker touchstart.ui.colorpicker",t),e.addEvent(this._saturation,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateSaturation(s.x,s.y),e.focus(this._saturationGuide)})),e.addEvent(this._saturationGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":this._values.saturation=Math.min(100,this._values.saturation+1);break;case"ArrowDown":this._values.brightness=Math.max(0,this._values.brightness-1);break;case"ArrowLeft":this._values.saturation=Math.max(0,this._values.saturation-1);break;case"ArrowUp":this._values.brightness=Math.min(100,this._values.brightness+1);break;default:return}t.preventDefault(),this._updateColor()}));const s=e.mouseDragFactory((t=>{if(t.button)return!1;e.focus(this._hueGuide)}),(t=>{const e=i.getPosition(t);this._updateHue(e.x,e.y)}));if(e.addEvent(this._hue,"mousedown.ui.colorpicker touchstart.ui.colorpicker",s),e.addEvent(this._hue,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateHue(s.x,s.y),e.focus(this._hueGuide)})),e.addEvent(this._hueGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":case"ArrowDown":this._values.hue=Math.max(0,this._values.hue-1);break;case"ArrowLeft":case"ArrowUp":this._values.hue=Math.min(360,this._values.hue+1);break;default:return}t.preventDefault(),this._updateColor()})),this._options.alpha){const t=t=>{if(t.button)return!1;e.focus(this._alphaGuide)},s=t=>{const e=i.getPosition(t);this._updateAlpha(e.x,e.y)},o=e.mouseDragFactory(t,s);e.addEvent(this._alpha,"mousedown.ui.colorpicker touchstart.ui.colorpicker",o),e.addEvent(this._alpha,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateAlpha(s.x,s.y),e.focus(this._alphaGuide)})),e.addEvent(this._alphaGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":case"ArrowDown":this._values.alpha=Math.max(0,this._values.alpha-.01);break;case"ArrowLeft":case"ArrowUp":this._values.alpha=Math.min(1,this._values.alpha+.01);break;default:return}t.preventDefault(),this._updateColor()}))}e.addEvent(this._node,"change.ui.colorpicker",(t=>{if(t.skipUpdate)return;const i=e.getValue(this._node),s=a(i);s?this._setColor(s):!this._options.keepInvalid&&i?this._setColor(this._color):(this._color=null,this._updateAttributes(),this._refresh())})),e.addEvent(this._menuNode,"keydown.ui.colorpicker",(t=>{switch(t.code){case"Enter":case"NumpadEnter":if(t.preventDefault(),this._options.inline)return;this._options.modal?this._keepColor=!0:e.focus(this._node),this.hide();break;case"Tab":if(!this._options.modal&&!this._options.inline){const i=e.find('[tabindex="0"]',this._menuNode),s=e.indexOf(i,t.target);t.shiftKey&&0===s?(t.preventDefault(),e.focus(this._node)):t.shiftKey||s!==i.length-1||(e.focus(this._node),this.hide())}}})),this._options.inline||(e.addEvent(this._node,"input.ui.colorpicker",(t=>{const i=a(e.getValue(this._node));i&&(this._color=i,this._updateAttributes(),this._refresh())})),e.addEvent(this._node,"click.ui.colorpicker",(t=>{"in"!==e.getDataset(this._menuNode,"uiAnimating")&&(this._options.modal?this._activeTarget=this._node:(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating")),this.show())})),this._options.modal||e.addEvent(this._node,"focus.ui.colorpicker",(t=>{e.isSame(this._node,document.activeElement)&&(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),this.show())})),e.addEvent(this._node,"keydown.ui.colorpicker",(t=>{switch(t.code){case"Enter":case"NumpadEnter":t.preventDefault(),this.toggle();break;case"Escape":e.isConnected(this._menuNode)&&(t.stopPropagation(),this.hide());break;case"Tab":t.shiftKey&&!this._options.modal&&e.isConnected(this._menuNode)?this.hide():t.shiftKey||this._options.modal||!e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||(t.preventDefault(),e.focus(this._saturationGuide))}})),this._inputGroupColor&&e.addEvent(this._inputGroupColor,"click.ui.colorpicker",(t=>{e.focus(this._node),this.toggle()})))},r._eventsModal=function(){let t;this._keepColor=!1,e.addEvent(this._modal,"show.ui.modal",(i=>{if(!e.triggerOne(this._node,"show.ui.colorpicker"))return!1;t=this._color})),e.addEvent(this._modal,"shown.ui.modal",(t=>{e.focus(this._saturationGuide),e.triggerEvent(this._node,"shown.ui.colorpicker")})),e.addEvent(this._modal,"hide.ui.modal",(t=>{if(!e.triggerOne(this._node,"hide.ui.colorpicker"))return this._keepColor=!1,!1;this._activeTarget=null,this._values.saturation=0,this._values.hue=0,this._keepColor&&this._setColor(this._color)})),e.addEvent(this._modal,"hidden.ui.modal",(i=>{this._keepColor||(this._setColor(t),t=null),this._keepColor=!1,e.detach(this._modal),e.triggerEvent(this._node,"hidden.ui.colorpicker")})),e.addEvent(this._setBtn,"click.ui.modal",(t=>{this._keepColor=!0}))},r._getString=function(t){if(!t)return"";switch(this._options.format){case"hex":return t.toHexString();case"rgb":return t.toRGBString();case"hsl":return t.toHSLString();default:return`${t}`}},r._isEditable=function(){return!e.is(this._node,":disabled")&&(this._options.ignoreReadonly||!e.is(this._node,":read-only"))},r._refresh=function({updateInputGroup:t=!0}={}){const i=s.fromHSV(this._values.hue,100,100);e.setStyle(this._saturation,{backgroundColor:i}),e.setStyle(this._saturationGuide,{top:100-this._values.brightness+"%",left:`${this._values.saturation}%`}),e.setAttribute(this._saturationGuide,{"aria-valuetext":`${this.constructor.lang.saturation} ${o(this._values.saturation/100)}, ${this.constructor.lang.brightness} ${o(this._values.brightness/100)}`});const a=100-this._values.hue/3.6+"%";if(this._options.horizontal?e.setStyle(this._hueGuide,{left:a}):e.setStyle(this._hueGuide,{top:a}),e.setAttribute(this._hueGuide,{"aria-valuetext":Math.round(this._values.hue)}),this._options.alpha){const t=s.fromHSV(this._values.hue,this._values.saturation,this._values.brightness),i=this._options.horizontal?"to right,":"";e.setStyle(this._alphaColor,{background:`linear-gradient(${i}${t} 0%, transparent 100%)`});const a=100-100*this._values.alpha+"%";this._options.horizontal?e.setStyle(this._alphaGuide,{left:a}):e.setStyle(this._alphaGuide,{top:a}),e.setAttribute(this._alphaGuide,{"aria-valuetext":o(this._values.alpha)})}const n=s.fromHSV(this._values.hue,this._values.saturation,this._values.brightness,this._values.alpha);e.setStyle(this._previewColor,{backgroundColor:n}),t&&this._inputGroupColor&&e.setStyle(this._inputGroupColor,{backgroundColor:n})},r._refreshDisabled=function(){this._native||(e.is(this._node,":disabled")?e.addClass(this._menuNode,this.constructor.classes.disabled):e.removeClass(this._menuNode,this.constructor.classes.disabled))},r._render=function(){if(this._menuNode=e.create("div",{class:this.constructor.classes.menu}),this._container=e.create("div",{class:this.constructor.classes.container}),e.append(this._menuNode,this._container),this._saturation=e.create("div",{class:this.constructor.classes.saturation}),e.append(this._container,this._saturation),this._saturationGuide=e.create("span",{class:this.constructor.classes.guide,attributes:{role:"slider",tabindex:0,"aria-label":this.constructor.lang.color}}),e.append(this._saturation,this._saturationGuide),this._hue=e.create("div",{class:this.constructor.classes.hue}),e.append(this._container,this._hue),this._hueGuide=e.create("span",{class:this.constructor.classes.guide,attributes:{role:"slider",tabindex:0,"aria-label":this.constructor.lang.hue}}),e.append(this._hue,this._hueGuide),this._options.alpha&&(this._alpha=e.create("div",{class:this.constructor.classes.alpha}),e.append(this._container,this._alpha),this._alphaColor=e.create("div",{class:this.constructor.classes.alphaColor}),e.append(this._alpha,this._alphaColor),this._alphaGuide=e.create("span",{class:this.constructor.classes.guide,attributes:{role:"slider",tabindex:0,"aria-label":this.constructor.lang.alpha}}),e.append(this._alpha,this._alphaGuide)),this._preview=e.create("div",{class:this.constructor.classes.preview}),e.append(this._menuNode,this._preview),this._previewColor=e.create("div"),e.append(this._preview,this._previewColor),this._options.horizontal){const t=this._options.modal?this.constructor.classes.spacingModal:this.constructor.classes.spacingHorizontal;e.addClass(this._menuNode,this.constructor.classes.menuHorizontal),e.addClass(this._container,this.constructor.classes.containerHorizontal),e.addClass(this._hue,t),this._options.alpha&&e.addClass(this._alpha,t),e.addClass(this._preview,t)}else e.addClass(this._saturation,this.constructor.classes.spacingVertical),this._options.alpha&&e.addClass(this._hue,this.constructor.classes.spacingVertical),e.addClass(this._preview,this.constructor.classes.spacingHorizontal);this._options.modal?e.addClass(this._menuNode,this.constructor.classes.menuModal):this._options.inline?(e.addClass(this._menuNode,this.constructor.classes.menuInline),e.after(this._node,this._menuNode),e.hide(this._node)):(e.addClass(this._menuNode,this.constructor.classes.menuPadding),e.setAttribute(this._menuNode,{role:"dialog","aria-modal":!0}))},r._renderModal=function(){this._modal=e.create("div",{class:this.constructor.classes.modal,attributes:{tabindex:-1,role:"dialog","aria-modal":!0}});const t=e.create("div",{class:this.constructor.classes.modalDialog});e.append(this._modal,t);const i=e.create("div",{class:this.constructor.classes.modalContent});e.append(t,i);const s=e.create("div",{class:this.constructor.classes.modalBody});e.append(s,this._menuNode);const o=e.create("div",{class:this.constructor.classes.modalBtnContainer});e.append(s,o);const a=e.create("button",{class:this.constructor.classes.modalBtnSecondary,text:"Cancel",attributes:{type:"button","data-ui-dismiss":"modal"}});e.append(o,a),this._setBtn=e.create("button",{class:this.constructor.classes.modalBtnPrimary,text:"Set",attributes:{type:"button","data-ui-dismiss":"modal","data-ui-set-color":"true"}}),e.append(o,this._setBtn),e.append(i,s)},r._setColor=function(t,{updateAttributes:i=!0,updateInputGroup:s=!0,updateValue:o=!0}={}){if(!this._isEditable())return;const a=this._color;this._color=t;const n=e.getValue(this._node),r=this._getString(t);i&&this._updateAttributes(),this._refresh({updateInputGroup:s}),o&&n!==r&&(e.setValue(this._node,r),e.triggerEvent(this._node,"change.ui.colorpicker",{data:{skipUpdate:!0},detail:{old:a,new:this._color}}))},r._updateAlpha=function(t,i){const s=this._options.horizontal?e.percentX(this._alpha,t,{offset:!0}):e.percentY(this._alpha,i,{offset:!0});this._values.alpha=1-s/100,this._updateColor()},r._updateAttributes=function(){const t=this._color||this._defaultColor;this._values.alpha=this._options.alpha?t.getAlpha():1,this._values.brightness=t.getBrightness(),this._values.brightness>0&&(this._values.saturation=t.getSaturation()),this._values.brightness>0&&this._values.saturation>0&&(this._values.hue=t.getHue())},r._updateColor=function(){const t=(this._color||this._defaultColor).setAlpha(this._values.alpha).setBrightness(this._values.brightness).setSaturation(this._values.saturation).setHue(this._values.hue);this._setColor(t,{updateAttributes:!1,updateInputGroup:!this._options.modal,updateValue:!this._options.modal})},r._updateHue=function(t,i){const s=this._options.horizontal?e.percentX(this._hue,t,{offset:!0}):e.percentY(this._hue,i,{offset:!0});this._values.hue=3.6*(100-s),this._updateColor()},r._updateSaturation=function(t,i){this._values.brightness=100-e.percentY(this._saturation,i,{offset:!0}),this._values.saturation=e.percentX(this._saturation,t,{offset:!0}),this._updateColor()},i.initComponent("colorpicker",n),e.addEvent(document,"mousedown.ui.colorpicker",(t=>{const i=e.find(".colorpicker:not(.colorpicker-inline):not(.colorpicker-modal)");for(const s of i){const i=e.getData(s,"input"),o=n.init(i);e.isSame(o._node,t.target)||e.isSame(o._menuNode,t.target)||e.hasDescendent(o._menuNode,t.target)||o.hide()}}),{capture:!0}),e.addEvent(document,"keydown.ui.colorpicker",(t=>{if("Escape"!==t.code)return;let i=!1;const s=e.find(".colorpicker:not(.colorpicker-inline):not(.colorpicker-modal)");for(const[o,a]of s.entries()){const s=e.getData(a,"input"),r=n.init(s);i||(i=!0,t.stopPropagation()),r.hide(),0==o&&e.focus(s)}}),{capture:!0}),t.ColorPicker=n}));