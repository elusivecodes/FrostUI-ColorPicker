!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@fr0st/query"),require("@fr0st/ui"),require("@fr0st/color")):"function"==typeof define&&define.amd?define(["exports","@fr0st/query","@fr0st/ui","@fr0st/color"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.fQuery,t.UI,t.Color)}(this,(function(t,e,i,s){"use strict";function o(t){return Number(t).toLocaleString("en-US",{style:"percent"})}function a(t){if(!t)return null;if(t instanceof s)return t;try{return s.fromString(t)}catch(t){return null}}class n extends i.BaseComponent{constructor(t,i){super(t,i);const o=e.getValue(this._node);"auto"===this._options.format&&(this._options.format=function(t){if(!t)return null;if("#"===t.substring(0,1))return"hex";const e=t.substring(0,3);return["rgb","hsl"].includes(e)?e:null}(o)),this._options.defaultColor&&(this._defaultColor=a(this._options.defaultColor)),this._defaultColor||(this._defaultColor=new s),this._color=a(o);let n=!0;this._color||(this._color=this._defaultColor,n=!1),this._options.inline?this._options.modal=!1:!this._options.modal&&this._options.mobileModal&&(this._options.modal=/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)),this._options.modal&&(this._options.horizontal=!0);const r=e.closest(this._node,".input-group").shift();if(r&&(this._inputGroupColor=e.findOne(".input-group-color",r)),n||o&&!this._options.keepInvalid){const t=this._getString(this._color);e.setValue(this._node,t)}this._render(),this._events(),this._options.modal&&(this._renderModal(),this._eventsModal()),e.setData(this._menuNode,{input:this._node}),this._values={alpha:1,brightness:0,hue:0,saturation:0},this._updateAttributes(),this._refresh(),this._refreshDisabled()}disable(){e.setAttribute(this._node,{disabled:!0}),this._refreshDisabled()}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),this._modal&&(i.Modal.init(this._modal).dispose(),this._modal=null),e.removeEvent(this._node,"change.ui.colorpicker"),e.removeEvent(this._node,"click.ui.colorpicker"),e.removeEvent(this._node,"focus.ui.colorpicker"),e.removeEvent(this._node,"blur.ui.colorpicker"),e.removeEvent(this._node,"keydown.ui.colorpicker"),e.removeEvent(this._node,"keyup.ui.colorpicker"),this._inputGroupColor&&(e.removeEvent(this._inputGroupColor,"mousedown.ui.colorpicker"),e.removeEvent(this._inputGroupColor,"click.ui.colorpicker")),e.remove(this._menuNode),this._color=null,this._defaultColor=null,this._inputGroupColor=null,this._menuNode=null,this._container=null,this._saturation=null,this._saturationGuide=null,this._hue=null,this._hueGuide=null,this._alpha=null,this._alphaColor=null,this._alphaGuide=null,this._preview=null,this._previewColor=null,this._values=null,this._dateOptions=null,this._modal=null,this._setBtn=null,super.dispose()}enable(){e.removeAttribute(this._node,"disabled"),this._refreshDisabled()}getColor(){return this._color}hide(){this._options.inline||(this._options.modal?i.Modal.init(this._modal).hide():e.isConnected(this._menuNode)&&!e.getDataset(this._menuNode,"uiAnimating")&&e.triggerOne(this._node,"hide.ui.colorpicker")&&(e.setDataset(this._menuNode,{uiAnimating:"out"}),e.fadeOut(this._menuNode,{duration:this._options.duration}).then((t=>{this._popper.dispose(),this._popper=null,e.detach(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),e.triggerEvent(this._node,"hidden.ui.colorpicker")})).catch((t=>{"out"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))))}setColor(t){(t=a(t))&&(this._options.alpha||(t=t.setAlpha(1)),this._setColor(t))}show(){if(!this._options.inline&&!e.isConnected(this._menuNode)&&this._isEditable()){if(this._options.modal){this._options.appendTo?e.append(this._options.appendTo,this._modal):e.after(this._node,this._modal);const t=i.Modal.init(this._modal);return this._activeTarget&&(t._activeTarget=this._activeTarget),void t.show()}!e.getDataset(this._menuNode,"uiAnimating")&&e.triggerOne(this._node,"show.ui.colorpicker")&&(e.setDataset(this._menuNode,{uiAnimating:"in"}),e.removeAttribute(this._saturationGuide,"tabindex"),e.removeAttribute(this._hueGuide,"tabindex"),this._options.alpha&&e.removeAttribute(this._alphaGuide,"tabindex"),this._options.appendTo?e.append(this._options.appendTo,this._menuNode):e.after(this._node,this._menuNode),this._popper=new i.Popper(this._menuNode,{reference:this._node,placement:this._options.placement,position:this._options.position,fixed:this._options.fixed,spacing:this._options.spacing,minContact:this._options.minContact}),e.fadeIn(this._menuNode,{duration:this._options.duration}).then((t=>{e.removeDataset(this._menuNode,"uiAnimating"),e.triggerEvent(this._node,"shown.ui.colorpicker")})).catch((t=>{"in"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")})))}}toggle(){e.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper&&this._popper.update()}}n.defaults={format:"auto",defaultColor:null,alpha:!0,inline:!1,horizontal:!1,keepInvalid:!1,ignoreReadonly:!1,modal:!1,mobileModal:!0,duration:100,appendTo:null,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},n.classes={alpha:"colorpicker-alpha flex-grow-1",alphaColor:"colorpicker-alpha-color",container:"d-flex justify-content-between",containerHorizontal:"flex-column",disabled:"colorpicker-disabled",guide:"colorpicker-guide",hue:"colorpicker-hue flex-grow-1",menu:"colorpicker",menuHorizontal:"colorpicker-horizontal",menuInline:"colorpicker-inline",menuPadding:"p-2",modal:"modal",modalBody:"modal-body",modalBtnContainer:"text-end mt-4",modalBtnPrimary:"btn btn-primary ripple ms-2",modalBtnSecondary:"btn btn-secondary ripple ms-2",modalContent:"modal-content",modalDialog:"modal-dialog modal-sm",preview:"colorpicker-bar colorpicker-preview mt-2",saturation:"colorpicker-saturation",spacingHorizontal:"mt-2",spacingVertical:"me-2"},n.lang={alpha:"Alpha",brightness:"Brightness",color:"Color",hue:"Hue",saturation:"Saturation"},n.parseColor=a;const r=n.prototype;r._events=function(){const t=e.mouseDragFactory((t=>{if(t.button)return!1;e.focus(this._saturationGuide)}),(t=>{const e=i.getPosition(t);this._updateSaturation(e.x,e.y)}));e.addEvent(this._saturation,"mousedown.ui.colorpicker touchstart.ui.colorpicker",t),e.addEvent(this._saturation,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateSaturation(s.x,s.y),e.focus(this._saturationGuide)})),e.addEvent(this._saturationGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":this._values.saturation=Math.min(100,this._values.saturation+1);break;case"ArrowDown":this._values.brightness=Math.max(0,this._values.brightness-1);break;case"ArrowLeft":this._values.saturation=Math.max(0,this._values.saturation-1);break;case"ArrowUp":this._values.brightness=Math.min(100,this._values.brightness+1);break;case"Tab":return void(!t.shiftKey||this._options.inline||this._options.modal||(t.preventDefault(),e.focus(this._node),this.hide()));default:return}t.preventDefault(),this._updateColor()}));const s=e.mouseDragFactory((t=>{if(t.button)return!1;e.focus(this._hueGuide)}),(t=>{const e=i.getPosition(t);this._updateHue(e.x,e.y)}));if(e.addEvent(this._hue,"mousedown.ui.colorpicker touchstart.ui.colorpicker",s),e.addEvent(this._hue,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateHue(s.x,s.y),e.focus(this._hueGuide)})),e.addEvent(this._hueGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":case"ArrowDown":this._values.hue=Math.max(0,this._values.hue-1);break;case"ArrowLeft":case"ArrowUp":this._values.hue=Math.min(360,this._values.hue+1);break;case"Tab":return void(t.shiftKey||this._options.inline||this._options.modal||this._options.alpha||(e.focus(this._node),e.setAttribute(this._saturationGuide,{tabindex:-1}),e.setAttribute(this._hueGuide,{tabindex:-1}),this.hide()));default:return}t.preventDefault(),this._updateColor()})),this._options.alpha){const t=t=>{if(t.button)return!1;e.focus(this._alphaGuide)},s=t=>{const e=i.getPosition(t);this._updateAlpha(e.x,e.y)},o=e.mouseDragFactory(t,s);e.addEvent(this._alpha,"mousedown.ui.colorpicker touchstart.ui.colorpicker",o),e.addEvent(this._alpha,"click.ui.colorpicker",(t=>{if(t.button)return!1;const s=i.getPosition(t);this._updateAlpha(s.x,s.y),e.focus(this._alphaGuide)})),e.addEvent(this._alphaGuide,"keydown.ui.colorpicker",(t=>{switch(t.code){case"ArrowRight":case"ArrowDown":this._values.alpha=Math.max(0,this._values.alpha-.01);break;case"ArrowLeft":case"ArrowUp":this._values.alpha=Math.min(1,this._values.alpha+.01);break;case"Tab":return void(t.shiftKey||this._options.inline||this._options.modal||(e.focus(this._node),e.setAttribute(this._saturationGuide,{tabindex:-1}),e.setAttribute(this._hueGuide,{tabindex:-1}),e.setAttribute(this._alphaGuide,{tabindex:-1}),this.hide()));default:return}t.preventDefault(),this._updateColor()}))}e.addEvent(this._node,"change.ui.colorpicker",(t=>{if(t.skipUpdate)return;const i=e.getValue(this._node),s=a(i);s?this._setColor(s):!this._options.keepInvalid&&i?this._setColor(this._color):(this._color=this._defaultColor,this._updateAttributes(),this._refresh())})),this._options.inline||(e.addEvent(this._menuNode,"click.ui.colorpicker",(t=>{t.stopPropagation()})),e.addEvent(this._node,"click.ui.colorpicker",(t=>{"in"!==e.getDataset(this._menuNode,"uiAnimating")&&(this._options.modal?this._activeTarget=this._node:(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating")),this.show())})),this._options.modal||e.addEvent(this._node,"focus.ui.colorpicker",(t=>{e.isSame(this._node,document.activeElement)&&(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),this.show())})),e.addEvent(this._node,"keydown.ui.colorpicker",(t=>{switch(t.code){case"Enter":case"NumpadEnter":t.preventDefault(),this.toggle();break;case"Tab":t.shiftKey&&!this._options.modal&&e.isConnected(this._menuNode)?this.hide():t.shiftKey||this._options.modal||!e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||(t.preventDefault(),e.focus(this._saturationGuide))}})),e.addEvent(this._node,"keyup.ui.colorpicker",(t=>{"Escape"===t.code&&e.isConnected(this._menuNode)&&(t.stopPropagation(),this.hide())})),this._inputGroupColor&&(e.addEvent(this._inputGroupColor,"mousedown.ui.colorpicker",(t=>{t.preventDefault()})),e.addEvent(this._inputGroupColor,"click.ui.colorpicker",(t=>{e.focus(this._node),this.toggle()}))))},r._eventsModal=function(){let t,i=!1;e.addEvent(this._modal,"show.ui.modal",(i=>{if(!e.triggerOne(this._node,"show.ui.colorpicker"))return!1;t=e.getValue(this._node)})),e.addEvent(this._modal,"shown.ui.modal",(t=>{e.triggerEvent(this._node,"shown.ui.colorpicker")})),e.addEvent(this._modal,"hide.ui.modal",(s=>{if(!e.triggerOne(this._node,"hide.ui.colorpicker"))return i=!1,!1;this._activeTarget=null,i||(e.setValue(this._node,t),e.triggerEvent(this._node,"change.ui.colorpicker"))})),e.addEvent(this._modal,"hidden.ui.modal",(t=>{i=!1,e.detach(this._modal),e.triggerEvent(this._node,"hidden.ui.colorpicker")})),e.addEvent(this._setBtn,"click.ui.modal",(t=>{i=!0}))},r._getString=function(t){switch(this._options.format){case"hex":return t.toHexString();case"rgb":return t.toRGBString();case"hsl":return t.toHSLString();default:return`${t}`}},r._isEditable=function(){return!e.is(this._node,":disabled")&&(this._options.ignoreReadonly||!e.is(this._node,":read-only"))},r._refresh=function(){const t=Color.fromHSV(this._values.hue,100,100);e.setStyle(this._saturation,{backgroundColor:t}),e.setStyle(this._saturationGuide,{top:100-this._values.brightness+"%",left:`${this._values.saturation}%`}),e.setAttribute(this._saturationGuide,{"aria-valuetext":`${this.constructor.lang.saturation} ${o(this._values.saturation/100)}, ${this.constructor.lang.brightness} ${o(this._values.brightness/100)}`});const i=100-this._values.hue/3.6+"%";if(this._options.horizontal?e.setStyle(this._hueGuide,{left:i}):e.setStyle(this._hueGuide,{top:i}),e.setAttribute(this._hueGuide,{"aria-valuetext":Math.round(this._values.hue)}),this._options.alpha){const t=Color.fromHSV(this._values.hue,this._values.saturation,this._values.brightness),i=this._options.horizontal?"to right,":"";e.setStyle(this._alphaColor,{background:`linear-gradient(${i}${t} 0%, transparent 100%)`});const s=100-100*this._values.alpha+"%";this._options.horizontal?e.setStyle(this._alphaGuide,{left:s}):e.setStyle(this._alphaGuide,{top:s}),e.setAttribute(this._alphaGuide,{"aria-valuetext":o(this._values.alpha)})}e.setStyle(this._previewColor,{backgroundColor:this._color}),this._inputGroupColor&&e.setStyle(this._inputGroupColor,{backgroundColor:this._color})},r._refreshDisabled=function(){this._native||(e.is(this._node,":disabled")?e.addClass(this._menuNode,this.constructor.classes.disabled):e.removeClass(this._menuNode,this.constructor.classes.disabled))},r._render=function(){this._menuNode=e.create("div",{class:this.constructor.classes.menu}),this._container=e.create("div",{class:this.constructor.classes.container}),e.append(this._menuNode,this._container),this._saturation=e.create("div",{class:this.constructor.classes.saturation}),e.append(this._container,this._saturation),this._saturationGuide=e.create("button",{class:this.constructor.classes.guide,attributes:{type:"button",role:"slider","aria-label":this.constructor.lang.color}}),e.append(this._saturation,this._saturationGuide),this._hue=e.create("div",{class:this.constructor.classes.hue}),e.append(this._container,this._hue),this._hueGuide=e.create("button",{class:this.constructor.classes.guide,attributes:{type:"button",role:"slider","aria-label":this.constructor.lang.hue}}),e.append(this._hue,this._hueGuide),this._options.alpha&&(this._alpha=e.create("div",{class:this.constructor.classes.alpha}),e.append(this._container,this._alpha),this._alphaColor=e.create("div",{class:this.constructor.classes.alphaColor}),e.append(this._alpha,this._alphaColor),this._alphaGuide=e.create("button",{class:this.constructor.classes.guide,attributes:{type:"button",role:"slider","aria-label":this.constructor.lang.alpha}}),e.append(this._alpha,this._alphaGuide)),this._preview=e.create("div",{class:this.constructor.classes.preview}),e.append(this._menuNode,this._preview),this._previewColor=e.create("div"),e.append(this._preview,this._previewColor),this._options.horizontal?(e.addClass(this._menuNode,this.constructor.classes.menuHorizontal),e.addClass(this._container,this.constructor.classes.containerHorizontal),e.addClass(this._hue,this.constructor.classes.spacingHorizontal),this._options.alpha&&e.addClass(this._alpha,this.constructor.classes.spacingHorizontal)):(e.addClass(this._saturation,this.constructor.classes.spacingVertical),this._options.alpha&&e.addClass(this._hue,this.constructor.classes.spacingVertical)),this._options.modal?e.addClass(this._menuNode,"colorpicker-modal"):this._options.inline?(e.addClass(this._menuNode,this.constructor.classes.menuInline),e.after(this._node,this._menuNode),e.hide(this._node)):(e.addClass(this._menuNode,this.constructor.classes.menuPadding),e.setAttribute(this._menuNode,{role:"dialog","aria-modal":!0}))},r._renderModal=function(){this._modal=e.create("div",{class:this.constructor.classes.modal,attributes:{tabindex:-1,role:"dialog","aria-modal":!0}});const t=e.create("div",{class:this.constructor.classes.modalDialog});e.append(this._modal,t);const i=e.create("div",{class:this.constructor.classes.modalContent});e.append(t,i);const s=e.create("div",{class:this.constructor.classes.modalBody});e.append(s,this._menuNode);const o=e.create("div",{class:this.constructor.classes.modalBtnContainer});e.append(s,o);const a=e.create("button",{class:this.constructor.classes.modalBtnSecondary,text:"Cancel",attributes:{type:"button","data-ui-dismiss":"modal"}});e.append(o,a),this._setBtn=e.create("button",{class:this.constructor.classes.modalBtnPrimary,text:"Set",attributes:{type:"button","data-ui-dismiss":"modal","data-ui-set-color":"true"}}),e.append(o,this._setBtn),e.append(i,s)},r._setColor=function(t,{updateAttributes:i=!0}={}){if(!this._isEditable())return;const s=this._color;this._color=t;const o=e.getValue(this._node),a=this._getString(t);i&&this._updateAttributes(),this._refresh(),o!==a&&(e.setValue(this._node,a),e.triggerEvent(this._node,"change.ui.colorpicker",{data:{skipUpdate:!0},detail:{old:s,new:this._color}}))},r._updateAlpha=function(t,i){const s=this._options.horizontal?e.percentX(this._alpha,t,{offset:!0}):e.percentY(this._alpha,i,{offset:!0});this._values.alpha=1-s/100,this._updateColor()},r._updateAttributes=function(){this._values.alpha=this._options.alpha?this._color.getAlpha():1,this._values.brightness=this._color.getBrightness(),this._values.brightness>0&&(this._values.saturation=this._color.getSaturation()),this._values.brightness>0&&this._values.saturation>0&&(this._values.hue=this._color.getHue())},r._updateColor=function(){const t=this.getColor().setAlpha(this._values.alpha).setBrightness(this._values.brightness).setHue(this._values.hue).setSaturation(this._values.saturation);this._setColor(t,!1)},r._updateHue=function(t,i){const s=this._options.horizontal?e.percentX(this._hue,t,{offset:!0}):e.percentY(this._hue,i,{offset:!0});this._values.hue=3.6*(100-s),this._updateColor()},r._updateSaturation=function(t,i){this._values.brightness=100-e.percentY(this._saturation,i,{offset:!0}),this._values.saturation=e.percentX(this._saturation,t,{offset:!0}),this._updateColor()},i.initComponent("colorpicker",n),e.addEvent(document,"click.ui.colorpicker",(t=>{const s=i.getClickTarget(t),o=e.find(".colorpicker:not(.colorpicker-inline):not(.colorpicker-modal)");for(const t of o){const i=e.getData(t,"input"),o=n.init(i);e.isSame(o._node,s)||e.isSame(o._menuNode,s)||e.hasDescendent(o._menuNode,s)||o.hide()}}),{capture:!0}),e.addEvent(document,"keyup.ui.colorpicker",(t=>{if("Escape"!==t.code)return;let i=!1;const s=e.find(".colorpicker:not(.colorpicker-inline):not(.colorpicker-modal)");for(const o of s){const s=e.getData(o,"input"),a=n.init(s);i||(i=!0,t.stopPropagation()),a.hide()}}),{capture:!0}),t.ColorPicker=n}));